<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lytspot - Sincronização de Dados</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .log-info { color: #0d6efd; }
        .log-success { color: #198754; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Lytspot - Sincronização de Dados</h1>
            <p class="text-gray-600 mt-2">Ferramenta administrativa para sincronização de dados entre ambientes</p>
            <p class="text-sm text-gray-500 mt-1">Versão 1.0.2 - <span id="environment">Detectando ambiente...</span></p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Painel de Sincronização para Produção -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sincronizar Dados para Produção</h2>
                <p class="text-gray-600 mb-6">
                    Esta operação irá copiar os dados de demonstração para o banco de dados de produção.
                    Útil quando você atualizou os serviços no ambiente de desenvolvimento e deseja
                    aplicar as mesmas alterações no ambiente de produção.
                </p>
                
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="forceUpdate" 
                            class="mr-2"
                        >
                        <label for="forceUpdate" class="text-gray-700">
                            Forçar atualização de serviços existentes
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="deleteExisting" 
                            class="mr-2"
                        >
                        <label for="deleteExisting" class="text-gray-700">
                            Excluir serviços existentes antes de sincronizar
                            <span class="text-red-500 text-sm ml-2">(Cuidado!)</span>
                        </label>
                    </div>
                    
                    <div class="mt-6">
                        <button 
                            id="syncToProdButton"
                            class="px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
                        >
                            Sincronizar para Produção
                        </button>
                    </div>
                </div>
                
                <div id="syncToProdResult" class="mt-6 p-4 rounded-md bg-gray-100 hidden">
                    <h3 class="font-semibold mb-2">Resultado da Sincronização:</h3>
                    <pre id="syncToProdResultContent" class="text-sm whitespace-pre-wrap overflow-auto max-h-60"></pre>
                </div>
            </div>
            
            <!-- Painel de Sincronização do Banco para Arquivo de Demonstração -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sincronizar Banco para Arquivo de Demonstração</h2>
                <p class="text-gray-600 mb-6">
                    Esta operação irá copiar os dados do banco de dados atual para o arquivo de dados de demonstração.
                    Útil quando você fez alterações diretamente no banco de dados e deseja atualizar o arquivo
                    de demonstração para refletir essas alterações.
                </p>
                
                <div class="mt-6">
                    <button 
                        id="syncFromProdButton"
                        class="px-4 py-2 rounded-md text-white bg-gray-600 hover:bg-gray-700"
                    >
                        Sincronizar do Banco para Arquivo
                    </button>
                </div>
                
                <div id="syncFromProdResult" class="mt-6 p-4 rounded-md bg-gray-100 hidden">
                    <h3 class="font-semibold mb-2">Resultado da Sincronização:</h3>
                    <pre id="syncFromProdResultContent" class="text-sm whitespace-pre-wrap overflow-auto max-h-60"></pre>
                </div>
            </div>
        </div>
        
        <!-- Log de Operações -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Log de Operações</h2>
            <div id="logContainer" class="log-container">
                <div class="log-info">[INFO] Carregando interface de sincronização...</div>
            </div>
        </div>
        
        <!-- Verificação de Status -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Status do Sistema</h2>
            <button 
                id="checkStatusButton"
                class="px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700"
            >
                Verificar Status
            </button>
            
            <div id="statusResult" class="mt-4 p-4 rounded-md bg-gray-100 hidden">
                <h3 class="font-semibold mb-2">Status do Sistema:</h3>
                <pre id="statusResultContent" class="text-sm whitespace-pre-wrap"></pre>
            </div>
        </div>
        
        <!-- Rodapé -->
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p>Lytspot - Ferramenta de Sincronização v1.0.2</p>
            <p class="mt-1"> 2025 Lytspot. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos da interface
            const logContainer = document.getElementById('logContainer');
            const syncToProdButton = document.getElementById('syncToProdButton');
            const syncFromProdButton = document.getElementById('syncFromProdButton');
            const checkStatusButton = document.getElementById('checkStatusButton');
            const forceUpdateCheckbox = document.getElementById('forceUpdate');
            const deleteExistingCheckbox = document.getElementById('deleteExisting');
            const syncToProdResult = document.getElementById('syncToProdResult');
            const syncToProdResultContent = document.getElementById('syncToProdResultContent');
            const syncFromProdResult = document.getElementById('syncFromProdResult');
            const syncFromProdResultContent = document.getElementById('syncFromProdResultContent');
            const statusResult = document.getElementById('statusResult');
            const statusResultContent = document.getElementById('statusResultContent');
            const environmentElement = document.getElementById('environment');
            
            // Configuração do Axios
            const baseURL = window.location.origin;
            const api = axios.create({
                baseURL: baseURL,
                timeout: 30000,
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            // Detectar ambiente
            const isLocalhost = window.location.hostname === 'localhost' || 
                                window.location.hostname.includes('192.168.') || 
                                window.location.hostname.includes('127.0.0.1');
            
            const environment = isLocalhost ? 'Desenvolvimento' : 'Produção';
            environmentElement.textContent = environment;
            
            // Função para adicionar entrada ao log
            function addToLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-${type}`;
                logEntry.textContent = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            // Inicialização
            addToLog(`Interface de sincronização carregada (Ambiente de ${environment})`);
            addToLog(`API configurada para: ${baseURL}`);
            
            // Verificar status do sistema
            checkStatusButton.addEventListener('click', async function() {
                try {
                    addToLog('Verificando status do sistema...');
                    checkStatusButton.disabled = true;
                    checkStatusButton.textContent = 'Verificando...';
                    
                    const response = await api.get('/sync/status');
                    
                    if (response.data.sucesso) {
                        addToLog(`Status verificado: ${response.data.mensagem}`, 'success');
                        statusResultContent.textContent = JSON.stringify(response.data, null, 2);
                        statusResult.classList.remove('hidden');
                        statusResult.classList.add('bg-green-100');
                    } else {
                        addToLog(`Erro ao verificar status: ${response.data.mensagem}`, 'error');
                        statusResultContent.textContent = JSON.stringify(response.data, null, 2);
                        statusResult.classList.remove('hidden');
                        statusResult.classList.add('bg-red-100');
                    }
                } catch (error) {
                    console.error('Erro ao verificar status:', error);
                    addToLog(`Erro ao verificar status: ${error.message || 'Erro desconhecido'}`, 'error');
                    statusResultContent.textContent = JSON.stringify(error.response?.data || { erro: error.message }, null, 2);
                    statusResult.classList.remove('hidden');
                    statusResult.classList.add('bg-red-100');
                } finally {
                    checkStatusButton.disabled = false;
                    checkStatusButton.textContent = 'Verificar Status';
                }
            });
            
            // Sincronizar para produção
            syncToProdButton.addEventListener('click', async function() {
                try {
                    // Confirmar se o usuário realmente quer excluir dados existentes
                    if (deleteExistingCheckbox.checked) {
                        const confirm = window.confirm(
                            'ATENÇÃO: Você está prestes a excluir todos os serviços existentes no banco de dados. ' +
                            'Esta ação não pode ser desfeita. Deseja continuar?'
                        );
                        if (!confirm) return;
                    }
                    
                    addToLog(`Iniciando sincronização para produção (forceUpdate=${forceUpdateCheckbox.checked}, deleteExisting=${deleteExistingCheckbox.checked})...`);
                    syncToProdButton.disabled = true;
                    syncToProdButton.textContent = 'Sincronizando...';
                    
                    const response = await api.post('/sync/sync-to-production', {
                        forceUpdate: forceUpdateCheckbox.checked,
                        deleteExisting: deleteExistingCheckbox.checked
                    });
                    
                    if (response.data.sucesso) {
                        addToLog(`Sincronização para produção concluída: ${response.data.mensagem}`, 'success');
                        
                        // Exibir estatísticas se disponíveis
                        if (response.data.detalhes && response.data.detalhes.stats) {
                            const stats = response.data.detalhes.stats;
                            addToLog(`Estatísticas: ${stats.created} criados, ${stats.updated} atualizados, ${stats.skipped} ignorados, ${stats.deleted} excluídos`, 'success');
                        }
                        
                        syncToProdResultContent.textContent = JSON.stringify(response.data, null, 2);
                        syncToProdResult.classList.remove('hidden', 'bg-red-100');
                        syncToProdResult.classList.add('bg-green-100');
                    } else {
                        addToLog(`Erro na sincronização para produção: ${response.data.mensagem}`, 'error');
                        syncToProdResultContent.textContent = JSON.stringify(response.data, null, 2);
                        syncToProdResult.classList.remove('hidden', 'bg-green-100');
                        syncToProdResult.classList.add('bg-red-100');
                    }
                } catch (error) {
                    console.error('Erro ao sincronizar para produção:', error);
                    const errorMessage = error.response?.data?.mensagem || error.message || 'Erro desconhecido';
                    addToLog(`Erro ao executar sincronização para produção: ${errorMessage}`, 'error');
                    syncToProdResultContent.textContent = JSON.stringify(error.response?.data || { erro: errorMessage }, null, 2);
                    syncToProdResult.classList.remove('hidden', 'bg-green-100');
                    syncToProdResult.classList.add('bg-red-100');
                } finally {
                    syncToProdButton.disabled = false;
                    syncToProdButton.textContent = 'Sincronizar para Produção';
                }
            });
            
            // Sincronizar do banco para arquivo
            syncFromProdButton.addEventListener('click', async function() {
                try {
                    addToLog('Iniciando sincronização do banco para arquivo de demonstração...');
                    syncFromProdButton.disabled = true;
                    syncFromProdButton.textContent = 'Sincronizando...';
                    
                    const response = await api.post('/sync/sync-from-production');
                    
                    if (response.data.sucesso) {
                        addToLog(`Sincronização do banco para arquivo concluída: ${response.data.mensagem}`, 'success');
                        
                        // Exibir informações adicionais se disponíveis
                        if (response.data.detalhes && response.data.detalhes.count) {
                            addToLog(`${response.data.detalhes.count} serviços exportados para o arquivo de demonstração`, 'success');
                        }
                        
                        if (response.data.detalhes && response.data.detalhes.backupPath) {
                            addToLog(`Backup criado em: ${response.data.detalhes.backupPath}`, 'info');
                        }
                        
                        syncFromProdResultContent.textContent = JSON.stringify(response.data, null, 2);
                        syncFromProdResult.classList.remove('hidden', 'bg-red-100');
                        syncFromProdResult.classList.add('bg-green-100');
                    } else {
                        addToLog(`Erro na sincronização do banco para arquivo: ${response.data.mensagem}`, 'error');
                        syncFromProdResultContent.textContent = JSON.stringify(response.data, null, 2);
                        syncFromProdResult.classList.remove('hidden', 'bg-green-100');
                        syncFromProdResult.classList.add('bg-red-100');
                    }
                } catch (error) {
                    console.error('Erro ao sincronizar do banco para arquivo:', error);
                    const errorMessage = error.response?.data?.mensagem || error.message || 'Erro desconhecido';
                    addToLog(`Erro ao executar sincronização do banco para arquivo: ${errorMessage}`, 'error');
                    syncFromProdResultContent.textContent = JSON.stringify(error.response?.data || { erro: errorMessage }, null, 2);
                    syncFromProdResult.classList.remove('hidden', 'bg-green-100');
                    syncFromProdResult.classList.add('bg-red-100');
                } finally {
                    syncFromProdButton.disabled = false;
                    syncFromProdButton.textContent = 'Sincronizar do Banco para Arquivo';
                }
            });
            
            // Verificar status inicialmente
            checkStatusButton.click();
        });
    </script>
</body>
</html>
