<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lytspot - Sincronização de Dados</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: all 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-success {
            background-color: #10b981;
            color: white;
            transition: all 0.2s;
        }
        .btn-success:hover {
            background-color: #059669;
        }
        .btn-disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Lytspot - Sincronização de Dados</h1>
            <p class="text-gray-600 mt-2">Ferramenta administrativa para sincronização de dados entre ambientes</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Painel de Sincronização para Produção -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sincronizar Dados para Produção</h2>
                <p class="text-gray-600 mb-6">
                    Esta operação irá copiar os dados de demonstração para o banco de dados de produção.
                    Útil quando você atualizou os serviços no ambiente de desenvolvimento e deseja
                    aplicar as mesmas alterações no ambiente de produção.
                </p>
                
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="forceUpdate" class="mr-2">
                        <label for="forceUpdate" class="text-gray-700">
                            Forçar atualização de serviços existentes
                        </label>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="deleteExisting" class="mr-2">
                        <label for="deleteExisting" class="text-gray-700">
                            Excluir serviços existentes antes de sincronizar
                            <span class="text-red-500 text-sm ml-2">(Cuidado!)</span>
                        </label>
                    </div>
                    
                    <div class="mt-6">
                        <button id="syncToProduction" class="btn-primary px-4 py-2 rounded-md">
                            Sincronizar para Produção
                        </button>
                    </div>
                </div>
                
                <div id="syncToProdResult" class="mt-6 p-4 bg-gray-100 rounded-md hidden">
                    <h3 class="font-semibold mb-2">Resultado da Sincronização:</h3>
                    <pre id="syncToProdResultText" class="text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>
            
            <!-- Painel de Sincronização do Banco para Arquivo de Demonstração -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Sincronizar Banco para Arquivo de Demonstração</h2>
                <p class="text-gray-600 mb-6">
                    Esta operação irá copiar os dados do banco de dados atual para o arquivo de dados de demonstração.
                    Útil quando você fez alterações diretamente no banco de dados e deseja atualizar o arquivo
                    de demonstração para refletir essas alterações.
                </p>
                
                <div class="mt-6">
                    <button id="syncFromProduction" class="btn-secondary px-4 py-2 rounded-md">
                        Sincronizar do Banco para Arquivo
                    </button>
                </div>
                
                <div id="syncFromProdResult" class="mt-6 p-4 bg-gray-100 rounded-md hidden">
                    <h3 class="font-semibold mb-2">Resultado da Sincronização:</h3>
                    <pre id="syncFromProdResultText" class="text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>
        </div>
        
        <!-- Log de Operações -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Log de Operações</h2>
            <div id="operationLog" class="bg-gray-100 p-4 rounded-md h-64 overflow-y-auto">
                <div class="text-gray-500 italic">Nenhuma operação realizada ainda.</div>
            </div>
        </div>
        
        <!-- Rodapé -->
        <footer class="mt-8 text-center text-gray-600 text-sm">
            <p>Lytspot - Ferramenta de Sincronização v1.0.0</p>
            <p class="mt-1">© 2025 Lytspot. Todos os direitos reservados.</p>
        </footer>
    </div>

    <script>
        // Função para adicionar uma entrada ao log
        function addToLog(message, type = 'info') {
            const logContainer = document.getElementById('operationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            // Definir classe de cor baseada no tipo
            let colorClass = 'text-gray-800';
            if (type === 'error') colorClass = 'text-red-600';
            if (type === 'success') colorClass = 'text-green-600';
            if (type === 'warning') colorClass = 'text-yellow-600';
            
            // Criar e adicionar a entrada de log
            const logEntry = document.createElement('div');
            logEntry.className = `${colorClass} text-sm mb-1`;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
            
            // Remover a mensagem inicial se for a primeira entrada
            if (logContainer.querySelector('.italic')) {
                logContainer.innerHTML = '';
            }
            
            // Adicionar a nova entrada
            logContainer.appendChild(logEntry);
            
            // Rolar para o final
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Função para exibir o resultado da sincronização
        function showSyncResult(containerId, textId, result, success) {
            const container = document.getElementById(containerId);
            const textElement = document.getElementById(textId);
            
            container.classList.remove('hidden');
            container.classList.remove('bg-green-100', 'bg-red-100');
            container.classList.add(success ? 'bg-green-100' : 'bg-red-100');
            
            textElement.textContent = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
        }
        
        // Função para obter o token JWT do localStorage
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }
        
        // Verificar se o usuário está autenticado
        function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                addToLog('Usuário não autenticado. Por favor, faça login primeiro.', 'error');
                return false;
            }
            return true;
        }
        
        // Configurar os botões de sincronização
        document.getElementById('syncToProduction').addEventListener('click', async function() {
            if (!checkAuth()) return;
            
            const forceUpdate = document.getElementById('forceUpdate').checked;
            const deleteExisting = document.getElementById('deleteExisting').checked;
            
            // Confirmar se o usuário realmente quer excluir dados existentes
            if (deleteExisting) {
                const confirm = window.confirm(
                    'ATENÇÃO: Você está prestes a excluir todos os serviços existentes no banco de dados. ' +
                    'Esta ação não pode ser desfeita. Deseja continuar?'
                );
                if (!confirm) return;
            }
            
            try {
                addToLog(`Iniciando sincronização para produção (forceUpdate=${forceUpdate}, deleteExisting=${deleteExisting})...`);
                
                const response = await fetch('/api/sync/sync-to-production', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({ forceUpdate, deleteExisting })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addToLog(`Sincronização para produção concluída: ${result.mensagem}`, 'success');
                    showSyncResult('syncToProdResult', 'syncToProdResultText', result, true);
                } else {
                    addToLog(`Erro na sincronização para produção: ${result.mensagem}`, 'error');
                    showSyncResult('syncToProdResult', 'syncToProdResultText', result, false);
                }
            } catch (error) {
                addToLog(`Erro ao executar sincronização para produção: ${error.message}`, 'error');
                showSyncResult('syncToProdResult', 'syncToProdResultText', { erro: error.message }, false);
            }
        });
        
        document.getElementById('syncFromProduction').addEventListener('click', async function() {
            if (!checkAuth()) return;
            
            try {
                addToLog('Iniciando sincronização do banco para arquivo de demonstração...');
                
                const response = await fetch('/api/sync/sync-from-production', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    addToLog(`Sincronização do banco para arquivo concluída: ${result.mensagem}`, 'success');
                    showSyncResult('syncFromProdResult', 'syncFromProdResultText', result, true);
                } else {
                    addToLog(`Erro na sincronização do banco para arquivo: ${result.mensagem}`, 'error');
                    showSyncResult('syncFromProdResult', 'syncFromProdResultText', result, false);
                }
            } catch (error) {
                addToLog(`Erro ao executar sincronização do banco para arquivo: ${error.message}`, 'error');
                showSyncResult('syncFromProdResult', 'syncFromProdResultText', { erro: error.message }, false);
            }
        });
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            addToLog('Página de sincronização carregada. Pronto para operações.', 'info');
            
            // Verificar autenticação
            if (!getAuthToken()) {
                addToLog('Aviso: Usuário não autenticado. Algumas operações podem falhar.', 'warning');
            }
        });
    </script>
</body>
</html>
