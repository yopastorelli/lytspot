/**
 * Script para atualiza√ß√£o em massa de servi√ßos em ambiente de produ√ß√£o
 * @version 1.0.1 - 2025-03-13
 * @description Permite atualizar servi√ßos em ambiente de produ√ß√£o de forma controlada
 */

import { PrismaClient } from '@prisma/client';
import dotenv from 'dotenv';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

// Configura√ß√£o do ambiente
dotenv.config();
const prisma = new PrismaClient();

// Obter o diret√≥rio atual
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Configura√ß√£o da atualiza√ß√£o
 * Modifique estas vari√°veis conforme necess√°rio para sua atualiza√ß√£o espec√≠fica
 */
const CONFIG = {
  // Definir como true para executar a atualiza√ß√£o, false para apenas simular
  EXECUTAR_ATUALIZACAO: true,
  
  // Filtro para selecionar quais servi√ßos atualizar (null para todos)
  // Exemplos: { id: 1 } para um servi√ßo espec√≠fico, { ativo: true } para todos ativos
  FILTRO_SERVICOS: null,
  
  // Tipo de atualiza√ß√£o de pre√ßo: 'fixo' ou 'percentual'
  TIPO_ATUALIZACAO_PRECO: 'percentual',
  
  // Valor para atualiza√ß√£o de pre√ßo
  // Se TIPO_ATUALIZACAO_PRECO for 'fixo', este √© o novo valor fixo
  // Se TIPO_ATUALIZACAO_PRECO for 'percentual', este √© o percentual de ajuste (ex: 10 para +10%)
  VALOR_ATUALIZACAO_PRECO: 0,
  
  // Campos a atualizar (true para atualizar, false para manter)
  ATUALIZAR_CAMPOS: {
    preco_base: true,
    descricao: true,
    duracao_media_captura: true,
    duracao_media_tratamento: true,
    entregaveis: true,
    nome: true
  },
  
  // Valores para os campos (ignorados se o respectivo campo em ATUALIZAR_CAMPOS for false)
  VALORES_CAMPOS: {
    // Valores padr√£o (usados apenas se n√£o houver valores espec√≠ficos para o servi√ßo)
    descricao: "Descri√ß√£o padr√£o",
    duracao_media_captura: "2 a 3 horas",
    duracao_media_tratamento: "at√© 10 dias √∫teis",
    entregaveis: "30 fotos editadas em alta resolu√ß√£o",
    
    // Valores espec√≠ficos para cada servi√ßo
    servicos: {
      // VLOG - Aventuras em Fam√≠lia (ID 7)
      7: {
        nome: "VLOG - Aventuras em Fam√≠lia",
        descricao: "Documenta√ß√£o em v√≠deo e foto da sua viagem em fam√≠lia. Um dia na praia, no campo, na montanha ou em pontos tur√≠sticos nos arredores da Grande Curitiba.",
        preco_base: 1500,
        duracao_media_captura: "6 a 8 horas",
        duracao_media_tratamento: "at√© 30 dias",
        entregaveis: "V√≠deo editado de at√© 15 minutos + V√≠deo Highlights (melhores momentos) de 1 minuto + 70 fotos em alta resolu√ß√£o. Entrega digital via link seguro e exclusivo."
      },
      
      // VLOG - Amigos e Comunidade (ID 8)
      8: {
        nome: "VLOG - Amigos e Comunidade",
        descricao: "Cobertura fotogr√°fica e de v√≠deo para grupos de amigos ou comunidades, perfeita para registrar viagens, encontros ou eventos colaborativos.",
        preco_base: 900,
        duracao_media_captura: "3 a 4 horas",
        duracao_media_tratamento: "at√© 15 dias",
        entregaveis: "V√≠deo editado de at√© 10 minutos + V√≠deo Highlights (melhores momentos) de 1 minuto + 50 fotos em alta resolu√ß√£o. Entrega digital via link seguro e exclusivo."
      },
      
      // Cobertura Fotogr√°fica de Evento Social (ID 3)
      3: {
        nome: "Cobertura Fotogr√°fica de Evento Social",
        descricao: "Registro fotogr√°fico completo de eventos sociais como anivers√°rios, formaturas e confraterniza√ß√µes. Fotos espont√¢neas (estilo fotojornalismo documental) e fotos posadas de grupos e individuais.",
        preco_base: 700,
        duracao_media_captura: "3 a 4 horas",
        duracao_media_tratamento: "at√© 10 dias",
        entregaveis: "250 fotos em alta resolu√ß√£o, selecionadas, organizadas e com tratamento b√°sico de cores. Entrega digital via link seguro e exclusivo."
      },
      
      // Filmagem de Evento Social (ID 4)
      4: {
        nome: "Filmagem de Evento Social",
        descricao: "Capta√ß√£o de v√≠deo para eventos sociais, incluindo edi√ß√£o b√°sica com trilha sonora e entrega em formato digital de alta qualidade.",
        preco_base: 800,
        duracao_media_captura: "3 a 4 horas",
        duracao_media_tratamento: "at√© 20 dias",
        entregaveis: "V√≠deo editado de at√© 5 minutos em 4K ou Full HD com tratamento b√°sico de cores. Entrega digital via link seguro e exclusivo."
      },
      
      // Ensaio Fotogr√°fico de Fam√≠lia (ID 2)
      2: {
        nome: "Ensaio Fotogr√°fico de Fam√≠lia",
        descricao: "Sess√£o fotogr√°fica em ambiente externo para fam√≠lias. Foco em momentos espont√¢neos e com luz natural. Inclui dire√ß√£o de poses de fotos em grupo ou individuais.",
        preco_base: 450,
        duracao_media_captura: "1 a 2 horas",
        duracao_media_tratamento: "at√© 10 dias",
        entregaveis: "70 fotos em alta resolu√ß√£o, selecionadas, organizadas e com tratamento b√°sico de cores. Entrega digital via link seguro e exclusivo."
      },
      
      // Filmagem A√©rea com Drone (ID 6)
      6: {
        nome: "Filmagem A√©rea com Drone",
        descricao: "Capta√ß√£o de v√≠deos a√©reos para ensaios de fam√≠lia, eventos sociais, im√≥veis e arquitetura ou projetos especiais, com equipamento profissional e piloto certificado.",
        preco_base: 450,
        duracao_media_captura: "1 a 2 horas",
        duracao_media_tratamento: "at√© 10 dias",
        entregaveis: "V√≠deo editado de at√© 2 minutos em 4K ou Full HD com tratamento b√°sico de cores. Entrega digital via link seguro e exclusivo."
      },
      
      // Fotografia A√©rea com Drone (ID 5)
      5: {
        nome: "Fotografia A√©rea com Drone",
        descricao: "Captura de imagens a√©reas de propriedades, eventos ou loca√ß√µes, com equipamento profissional e piloto certificado.",
        preco_base: 350,
        duracao_media_captura: "1 a 2 horas",
        duracao_media_tratamento: "at√© 10 dias",
        entregaveis: "30 fotos em alta resolu√ß√£o, selecionadas, organizadas e com tratamento b√°sico de cores. Entrega digital via link seguro e exclusivo."
      },
      
      // Ensaio Fotogr√°fico Pessoal (ID 1) - Desativado
      1: {
        nome: "Ensaio Fotogr√°fico Pessoal",
        descricao: "Sess√£o individual em loca√ß√£o externa ou est√∫dio, ideal para redes sociais, uso profissional ou pessoal.",
        preco_base: 350,
        duracao_media_captura: "1 a 2 horas",
        duracao_media_tratamento: "7 dias √∫teis",
        entregaveis: "20 fotos editadas em alta resolu√ß√£o",
        ativo: false
      }
    }
  },
  
  // Sincronizar dados de demonstra√ß√£o ap√≥s a atualiza√ß√£o
  SINCRONIZAR_DADOS: true
};

/**
 * Fun√ß√£o para atualizar um servi√ßo com valores espec√≠ficos
 */
async function atualizarServicoComValoresEspecificos(servico, dadosAtualizados) {
  // Verificar se h√° valores espec√≠ficos para este servi√ßo
  const valoresEspecificos = CONFIG.VALORES_CAMPOS.servicos[servico.id];
  
  if (valoresEspecificos) {
    // Usar os valores espec√≠ficos para este servi√ßo
    if (CONFIG.ATUALIZAR_CAMPOS.preco_base && valoresEspecificos.preco_base !== undefined) {
      dadosAtualizados.preco_base = valoresEspecificos.preco_base;
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.descricao && valoresEspecificos.descricao !== undefined) {
      dadosAtualizados.descricao = valoresEspecificos.descricao;
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura && valoresEspecificos.duracao_media_captura !== undefined) {
      dadosAtualizados.duracao_media_captura = valoresEspecificos.duracao_media_captura;
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento && valoresEspecificos.duracao_media_tratamento !== undefined) {
      dadosAtualizados.duracao_media_tratamento = valoresEspecificos.duracao_media_tratamento;
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.entregaveis && valoresEspecificos.entregaveis !== undefined) {
      dadosAtualizados.entregaveis = valoresEspecificos.entregaveis;
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.nome && valoresEspecificos.nome !== undefined) {
      dadosAtualizados.nome = valoresEspecificos.nome;
    }
    
    if (valoresEspecificos.ativo !== undefined) {
      dadosAtualizados.ativo = valoresEspecificos.ativo;
    }
    
    return true;
  }
  
  return false;
}

/**
 * Fun√ß√£o principal para atualiza√ß√£o em massa
 */
async function atualizarServicosEmMassa() {
  try {
    console.log('\nüîÑ Iniciando atualiza√ß√£o em massa de servi√ßos em produ√ß√£o...\n');
    
    if (!CONFIG.EXECUTAR_ATUALIZACAO) {
      console.log('‚ö†Ô∏è MODO SIMULA√á√ÉO: Nenhuma altera√ß√£o ser√° salva no banco de dados.');
      console.log('‚ö†Ô∏è Para executar a atualiza√ß√£o, altere CONFIG.EXECUTAR_ATUALIZACAO para true.\n');
    }
    
    // Verificar conex√£o com o banco de dados
    try {
      const totalServicos = await prisma.servico.count();
      console.log(`‚úÖ Conex√£o com banco de dados estabelecida. Total de servi√ßos: ${totalServicos}`);
    } catch (error) {
      console.error('‚ùå Erro ao conectar ao banco de dados:', error.message);
      return;
    }
    
    // Obter servi√ßos com base no filtro
    const filtro = CONFIG.FILTRO_SERVICOS || {};
    const servicos = await prisma.servico.findMany({
      where: filtro,
      orderBy: { id: 'asc' }
    });
    
    if (servicos.length === 0) {
      console.error('‚ùå Nenhum servi√ßo encontrado com os crit√©rios especificados.');
      return;
    }
    
    console.log(`üìã Encontrados ${servicos.length} servi√ßos para atualiza√ß√£o.`);
    
    // Exibir servi√ßos que ser√£o atualizados
    console.log('\nüìã Servi√ßos que ser√£o atualizados:');
    servicos.forEach((servico, index) => {
      console.log(`${index + 1}. ${servico.nome} (ID: ${servico.id}) - R$ ${servico.preco_base.toFixed(2)}`);
    });
    
    // Exibir configura√ß√£o da atualiza√ß√£o
    console.log('\n‚öôÔ∏è Configura√ß√£o da atualiza√ß√£o:');
    
    if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
      if (CONFIG.TIPO_ATUALIZACAO_PRECO === 'percentual') {
        console.log(`- Pre√ßo Base: Ajuste de ${CONFIG.VALOR_ATUALIZACAO_PRECO > 0 ? '+' : ''}${CONFIG.VALOR_ATUALIZACAO_PRECO}%`);
      } else {
        console.log(`- Pre√ßo Base: Valor fixo de R$ ${CONFIG.VALOR_ATUALIZACAO_PRECO.toFixed(2)}`);
      }
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
      console.log(`- Descri√ß√£o: Valores espec√≠ficos por servi√ßo`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
      console.log(`- Dura√ß√£o M√©dia (Captura): Valores espec√≠ficos por servi√ßo`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
      console.log(`- Dura√ß√£o M√©dia (Tratamento): Valores espec√≠ficos por servi√ßo`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
      console.log(`- Entreg√°veis: Valores espec√≠ficos por servi√ßo`);
    }
    
    console.log(`- Sincronizar dados ap√≥s atualiza√ß√£o: ${CONFIG.SINCRONIZAR_DADOS ? 'Sim' : 'N√£o'}`);
    
    // Executar a atualiza√ß√£o
    console.log('\nüîÑ Executando atualiza√ß√£o...');
    
    const resultados = [];
    const erros = [];
    
    for (const servico of servicos) {
      try {
        const dadosAtualizados = {};
        
        // Tentar atualizar com valores espec√≠ficos
        const usouValoresEspecificos = await atualizarServicoComValoresEspecificos(servico, dadosAtualizados);
        
        // Se n√£o usou valores espec√≠ficos, usar a l√≥gica padr√£o
        if (!usouValoresEspecificos) {
          // Atualizar pre√ßo base
          if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
            if (CONFIG.TIPO_ATUALIZACAO_PRECO === 'percentual') {
              const percentual = CONFIG.VALOR_ATUALIZACAO_PRECO / 100;
              const valorAtual = parseFloat(servico.preco_base);
              const aumento = valorAtual * percentual;
              dadosAtualizados.preco_base = valorAtual + aumento;
            } else {
              dadosAtualizados.preco_base = CONFIG.VALOR_ATUALIZACAO_PRECO;
            }
          }
          
          // Atualizar outros campos
          if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
            dadosAtualizados.descricao = CONFIG.VALORES_CAMPOS.descricao;
          }
          
          if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
            dadosAtualizados.duracao_media_captura = CONFIG.VALORES_CAMPOS.duracao_media_captura;
          }
          
          if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
            dadosAtualizados.duracao_media_tratamento = CONFIG.VALORES_CAMPOS.duracao_media_tratamento;
          }
          
          if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
            dadosAtualizados.entregaveis = CONFIG.VALORES_CAMPOS.entregaveis;
          }
        }
        
        // Exibir dados que ser√£o atualizados
        console.log(`\nüìù Servi√ßo: ${servico.nome} (ID: ${servico.id})`);
        console.log('   Dados atuais:');
        if (CONFIG.ATUALIZAR_CAMPOS.nome) {
          console.log(`   - Nome: "${servico.nome}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
          console.log(`   - Pre√ßo Base: R$ ${servico.preco_base.toFixed(2)}`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
          console.log(`   - Descri√ß√£o: "${servico.descricao}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
          console.log(`   - Dura√ß√£o M√©dia (Captura): "${servico.duracao_media_captura}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
          console.log(`   - Dura√ß√£o M√©dia (Tratamento): "${servico.duracao_media_tratamento}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
          console.log(`   - Entreg√°veis: "${servico.entregaveis}"`);
        }
        
        console.log('   Novos dados:');
        if (dadosAtualizados.nome) {
          console.log(`   - Nome: "${dadosAtualizados.nome}"`);
        }
        if (dadosAtualizados.preco_base) {
          console.log(`   - Pre√ßo Base: R$ ${dadosAtualizados.preco_base.toFixed(2)}`);
        }
        if (dadosAtualizados.descricao) {
          console.log(`   - Descri√ß√£o: "${dadosAtualizados.descricao}"`);
        }
        if (dadosAtualizados.duracao_media_captura) {
          console.log(`   - Dura√ß√£o M√©dia (Captura): "${dadosAtualizados.duracao_media_captura}"`);
        }
        if (dadosAtualizados.duracao_media_tratamento) {
          console.log(`   - Dura√ß√£o M√©dia (Tratamento): "${dadosAtualizados.duracao_media_tratamento}"`);
        }
        if (dadosAtualizados.entregaveis) {
          console.log(`   - Entreg√°veis: "${dadosAtualizados.entregaveis}"`);
        }
        if (dadosAtualizados.ativo !== undefined) {
          console.log(`   - Ativo: ${dadosAtualizados.ativo ? 'Sim' : 'N√£o'}`);
        }
        
        // Executar a atualiza√ß√£o no banco de dados
        if (CONFIG.EXECUTAR_ATUALIZACAO) {
          const resultado = await prisma.servico.update({
            where: { id: servico.id },
            data: dadosAtualizados
          });
          
          resultados.push(resultado);
          console.log('   ‚úÖ Atualiza√ß√£o realizada com sucesso!');
        } else {
          console.log('   ‚ÑπÔ∏è Simula√ß√£o: Nenhuma altera√ß√£o foi salva no banco de dados.');
        }
      } catch (error) {
        console.error(`   ‚ùå Erro ao atualizar servi√ßo ${servico.id}:`, error.message);
        erros.push({ id: servico.id, erro: error.message });
      }
    }
    
    // Resumo da atualiza√ß√£o
    console.log('\nüìä Resumo da atualiza√ß√£o:');
    console.log(`- Total de servi√ßos processados: ${servicos.length}`);
    console.log(`- Atualiza√ß√µes bem-sucedidas: ${resultados.length}`);
    console.log(`- Erros: ${erros.length}`);
    
    if (erros.length > 0) {
      console.log('\n‚ùå Erros encontrados:');
      erros.forEach((erro, index) => {
        console.log(`${index + 1}. Servi√ßo ID ${erro.id}: ${erro.erro}`);
      });
    }
    
    // Sincronizar dados de demonstra√ß√£o
    if (CONFIG.SINCRONIZAR_DADOS && CONFIG.EXECUTAR_ATUALIZACAO) {
      console.log('\nüîÑ Sincronizando dados de demonstra√ß√£o...');
      
      try {
        // Caminho para o script de atualiza√ß√£o de dados de demonstra√ß√£o
        const scriptPath = path.join(__dirname, 'atualizarDadosDemonstracao.js');
        
        // Verificar se o script existe
        try {
          await fs.access(scriptPath);
        } catch (error) {
          console.error('‚ùå Script de atualiza√ß√£o de dados de demonstra√ß√£o n√£o encontrado.');
          return;
        }
        
        // Executar o script
        const { exec } = await import('child_process');
        
        exec(`node ${scriptPath}`, (error, stdout, stderr) => {
          if (error) {
            console.error('‚ùå Erro ao sincronizar dados de demonstra√ß√£o:', error.message);
            return;
          }
          
          if (stderr) {
            console.error('‚ùå Erro ao sincronizar dados de demonstra√ß√£o:', stderr);
            return;
          }
          
          console.log('‚úÖ Dados de demonstra√ß√£o sincronizados com sucesso!');
          console.log(stdout);
        });
      } catch (error) {
        console.error('‚ùå Erro ao sincronizar dados de demonstra√ß√£o:', error.message);
      }
    }
    
    console.log('\n‚úÖ Processo de atualiza√ß√£o conclu√≠do!');
  } catch (error) {
    console.error('‚ùå Erro durante a atualiza√ß√£o em massa:', error.message);
  } finally {
    await prisma.$disconnect();
  }
}

// Executar a fun√ß√£o principal
atualizarServicosEmMassa()
  .then(() => {
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Erro fatal:', error.message);
    process.exit(1);
  });
