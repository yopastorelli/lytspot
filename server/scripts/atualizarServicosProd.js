/**
 * Script para atualiza√ß√£o em massa de servi√ßos em ambiente de produ√ß√£o
 * @version 1.0.0 - 2025-03-13
 * @description Permite atualizar servi√ßos em ambiente de produ√ß√£o de forma controlada
 */

import { PrismaClient } from '@prisma/client';
import dotenv from 'dotenv';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

// Configura√ß√£o do ambiente
dotenv.config();
const prisma = new PrismaClient();

// Obter o diret√≥rio atual
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Configura√ß√£o da atualiza√ß√£o
 * Modifique estas vari√°veis conforme necess√°rio para sua atualiza√ß√£o espec√≠fica
 */
const CONFIG = {
  // Definir como true para executar a atualiza√ß√£o, false para apenas simular
  EXECUTAR_ATUALIZACAO: false,
  
  // Filtro para selecionar quais servi√ßos atualizar (null para todos)
  // Exemplos: { id: 1 } para um servi√ßo espec√≠fico, { ativo: true } para todos ativos
  FILTRO_SERVICOS: null,
  
  // Tipo de atualiza√ß√£o de pre√ßo: 'fixo' ou 'percentual'
  TIPO_ATUALIZACAO_PRECO: 'percentual',
  
  // Valor para atualiza√ß√£o de pre√ßo
  // Se TIPO_ATUALIZACAO_PRECO for 'fixo', este √© o novo valor fixo
  // Se TIPO_ATUALIZACAO_PRECO for 'percentual', este √© o percentual de ajuste (ex: 10 para +10%)
  VALOR_ATUALIZACAO_PRECO: 10,
  
  // Campos a atualizar (true para atualizar, false para manter)
  ATUALIZAR_CAMPOS: {
    preco_base: true,
    descricao: false,
    duracao_media_captura: false,
    duracao_media_tratamento: false,
    entregaveis: false
  },
  
  // Valores para os campos (ignorados se o respectivo campo em ATUALIZAR_CAMPOS for false)
  VALORES_CAMPOS: {
    descricao: "Nova descri√ß√£o padr√£o",
    duracao_media_captura: "2 a 3 horas",
    duracao_media_tratamento: "at√© 7 dias √∫teis",
    entregaveis: "30 fotos editadas em alta resolu√ß√£o"
  },
  
  // Sincronizar dados de demonstra√ß√£o ap√≥s a atualiza√ß√£o
  SINCRONIZAR_DADOS: true
};

/**
 * Fun√ß√£o principal para atualiza√ß√£o em massa
 */
async function atualizarServicosEmMassa() {
  try {
    console.log('\nüîÑ Iniciando atualiza√ß√£o em massa de servi√ßos em produ√ß√£o...\n');
    
    if (!CONFIG.EXECUTAR_ATUALIZACAO) {
      console.log('‚ö†Ô∏è MODO SIMULA√á√ÉO: Nenhuma altera√ß√£o ser√° salva no banco de dados.');
      console.log('‚ö†Ô∏è Para executar a atualiza√ß√£o, altere CONFIG.EXECUTAR_ATUALIZACAO para true.\n');
    }
    
    // Verificar conex√£o com o banco de dados
    try {
      const totalServicos = await prisma.servico.count();
      console.log(`‚úÖ Conex√£o com banco de dados estabelecida. Total de servi√ßos: ${totalServicos}`);
    } catch (error) {
      console.error('‚ùå Erro ao conectar ao banco de dados:', error.message);
      return;
    }
    
    // Obter servi√ßos com base no filtro
    const filtro = CONFIG.FILTRO_SERVICOS || {};
    const servicos = await prisma.servico.findMany({
      where: filtro,
      orderBy: { id: 'asc' }
    });
    
    if (servicos.length === 0) {
      console.error('‚ùå Nenhum servi√ßo encontrado com os crit√©rios especificados.');
      return;
    }
    
    console.log(`üìã Encontrados ${servicos.length} servi√ßos para atualiza√ß√£o.`);
    
    // Exibir servi√ßos que ser√£o atualizados
    console.log('\nüìã Servi√ßos que ser√£o atualizados:');
    servicos.forEach((servico, index) => {
      console.log(`${index + 1}. ${servico.nome} (ID: ${servico.id}) - R$ ${servico.preco_base.toFixed(2)}`);
    });
    
    // Exibir configura√ß√£o da atualiza√ß√£o
    console.log('\n‚öôÔ∏è Configura√ß√£o da atualiza√ß√£o:');
    
    if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
      if (CONFIG.TIPO_ATUALIZACAO_PRECO === 'percentual') {
        console.log(`- Pre√ßo Base: Ajuste de ${CONFIG.VALOR_ATUALIZACAO_PRECO > 0 ? '+' : ''}${CONFIG.VALOR_ATUALIZACAO_PRECO}%`);
      } else {
        console.log(`- Pre√ßo Base: Valor fixo de R$ ${CONFIG.VALOR_ATUALIZACAO_PRECO.toFixed(2)}`);
      }
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
      console.log(`- Descri√ß√£o: "${CONFIG.VALORES_CAMPOS.descricao}"`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
      console.log(`- Dura√ß√£o M√©dia (Captura): "${CONFIG.VALORES_CAMPOS.duracao_media_captura}"`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
      console.log(`- Dura√ß√£o M√©dia (Tratamento): "${CONFIG.VALORES_CAMPOS.duracao_media_tratamento}"`);
    }
    
    if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
      console.log(`- Entreg√°veis: "${CONFIG.VALORES_CAMPOS.entregaveis}"`);
    }
    
    console.log(`- Sincronizar dados ap√≥s atualiza√ß√£o: ${CONFIG.SINCRONIZAR_DADOS ? 'Sim' : 'N√£o'}`);
    
    // Executar a atualiza√ß√£o
    console.log('\nüîÑ Executando atualiza√ß√£o...');
    
    const resultados = [];
    const erros = [];
    
    for (const servico of servicos) {
      try {
        const dadosAtualizados = {};
        
        // Atualizar pre√ßo base
        if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
          if (CONFIG.TIPO_ATUALIZACAO_PRECO === 'percentual') {
            const percentual = CONFIG.VALOR_ATUALIZACAO_PRECO / 100;
            const valorAtual = parseFloat(servico.preco_base);
            const aumento = valorAtual * percentual;
            dadosAtualizados.preco_base = valorAtual + aumento;
          } else {
            dadosAtualizados.preco_base = CONFIG.VALOR_ATUALIZACAO_PRECO;
          }
        }
        
        // Atualizar outros campos
        if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
          dadosAtualizados.descricao = CONFIG.VALORES_CAMPOS.descricao;
        }
        
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
          dadosAtualizados.duracao_media_captura = CONFIG.VALORES_CAMPOS.duracao_media_captura;
        }
        
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
          dadosAtualizados.duracao_media_tratamento = CONFIG.VALORES_CAMPOS.duracao_media_tratamento;
        }
        
        if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
          dadosAtualizados.entregaveis = CONFIG.VALORES_CAMPOS.entregaveis;
        }
        
        // Exibir dados que ser√£o atualizados
        console.log(`\nüìù Servi√ßo: ${servico.nome} (ID: ${servico.id})`);
        console.log('   Dados atuais:');
        if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
          console.log(`   - Pre√ßo Base: R$ ${servico.preco_base.toFixed(2)}`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
          console.log(`   - Descri√ß√£o: "${servico.descricao}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
          console.log(`   - Dura√ß√£o M√©dia (Captura): "${servico.duracao_media_captura}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
          console.log(`   - Dura√ß√£o M√©dia (Tratamento): "${servico.duracao_media_tratamento}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
          console.log(`   - Entreg√°veis: "${servico.entregaveis}"`);
        }
        
        console.log('   Novos dados:');
        if (CONFIG.ATUALIZAR_CAMPOS.preco_base) {
          console.log(`   - Pre√ßo Base: R$ ${dadosAtualizados.preco_base.toFixed(2)}`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.descricao) {
          console.log(`   - Descri√ß√£o: "${dadosAtualizados.descricao}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_captura) {
          console.log(`   - Dura√ß√£o M√©dia (Captura): "${dadosAtualizados.duracao_media_captura}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.duracao_media_tratamento) {
          console.log(`   - Dura√ß√£o M√©dia (Tratamento): "${dadosAtualizados.duracao_media_tratamento}"`);
        }
        if (CONFIG.ATUALIZAR_CAMPOS.entregaveis) {
          console.log(`   - Entreg√°veis: "${dadosAtualizados.entregaveis}"`);
        }
        
        // Atualizar no banco de dados (se n√£o estiver em modo simula√ß√£o)
        if (CONFIG.EXECUTAR_ATUALIZACAO) {
          await prisma.servico.update({
            where: { id: servico.id },
            data: dadosAtualizados
          });
          
          console.log('   ‚úÖ Servi√ßo atualizado com sucesso!');
        } else {
          console.log('   ‚ö†Ô∏è SIMULA√á√ÉO: Servi√ßo n√£o foi atualizado.');
        }
        
        resultados.push({
          id: servico.id,
          nome: servico.nome,
          status: CONFIG.EXECUTAR_ATUALIZACAO ? 'atualizado' : 'simulado'
        });
      } catch (error) {
        console.error(`‚ùå Erro ao atualizar servi√ßo ${servico.nome} (ID: ${servico.id}):`, error.message);
        erros.push({
          id: servico.id,
          nome: servico.nome,
          erro: error.message
        });
      }
    }
    
    // Resumo da opera√ß√£o
    console.log('\nüìä Resumo da opera√ß√£o:');
    console.log(`   - Total de servi√ßos processados: ${servicos.length}`);
    console.log(`   - Servi√ßos atualizados com sucesso: ${resultados.length}`);
    console.log(`   - Erros: ${erros.length}`);
    
    if (erros.length > 0) {
      console.log('\n‚ùå Servi√ßos com erro:');
      erros.forEach(erro => {
        console.log(`   - ${erro.nome} (ID: ${erro.id}): ${erro.erro}`);
      });
    }
    
    // Sincronizar dados de demonstra√ß√£o ap√≥s a atualiza√ß√£o
    if (CONFIG.SINCRONIZAR_DADOS && CONFIG.EXECUTAR_ATUALIZACAO) {
      console.log('\nüîÑ Sincronizando dados de demonstra√ß√£o...');
      
      try {
        const { default: atualizarDadosDemonstracao } = await import('./atualizarDadosDemonstracao.js');
        await atualizarDadosDemonstracao();
        console.log('‚úÖ Dados de demonstra√ß√£o sincronizados com sucesso!');
      } catch (error) {
        console.error('‚ùå Erro ao sincronizar dados de demonstra√ß√£o:', error.message);
      }
    }
    
    console.log('\n‚ú® Opera√ß√£o conclu√≠da!');
    
    if (!CONFIG.EXECUTAR_ATUALIZACAO) {
      console.log('\n‚ö†Ô∏è LEMBRETE: Esta foi apenas uma simula√ß√£o. Nenhuma altera√ß√£o foi salva no banco de dados.');
      console.log('‚ö†Ô∏è Para executar a atualiza√ß√£o real, altere CONFIG.EXECUTAR_ATUALIZACAO para true e execute novamente.');
    }
    
  } catch (error) {
    console.error('‚ùå Erro durante a execu√ß√£o:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Executar a fun√ß√£o principal
atualizarServicosEmMassa()
  .then(() => {
    process.exit(0);
  })
  .catch((error) => {
    console.error('‚ùå Erro fatal:', error);
    process.exit(1);
  });
